<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Siswa QR (Firebase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- PERUBAHAN 1: Memuat Firebase SDK dari URL Hosting khusus -->
    <!-- URL ini hanya berfungsi saat aplikasi di-deploy di Firebase Hosting -->
    <script src="/__/firebase/9.15.0/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.15.0/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.15.0/firebase-firestore-compat.js"></script>
    <!-- Skrip ini akan memuat konfigurasi secara otomatis dan aman -->
    <script src="/__/firebase/init.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        #qr-reader video { width: 100% !important; height: auto !important; border-radius: 0.5rem; }
        #qr-reader-region { border: none !important; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #4f46e5; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal { transition: opacity 0.3s ease; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
        .qr-card {
            width: 200px;
            height: 320px;
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: white;
            page-break-inside: avoid;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ===== LAYAR LOGIN ===== -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gray-200 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
            <div class="flex justify-center mb-6">
                 <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-600"><path d="M3 3h18v18H3zM9 9h6v6H9z"/><path d="M3 9h2M3 15h2M19 9h2M19 15h2M9 3v2M15 3v2M9 19v2M15 19v2"/></svg>
            </div>
            <h2 class="text-2xl font-bold text-center mb-2">Absensi Siswa QR Code</h2>
            <p class="text-center text-gray-500 mb-6">Silakan masuk untuk melanjutkan.</p>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="email" class="block mb-1 font-medium text-gray-700">Email</label>
                    <input type="email" id="email" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="block mb-1 font-medium text-gray-700">Password</label>
                    <input type="password" id="password" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <div class="text-right mb-4">
                    <a href="#" id="forgot-password-link" class="text-sm text-indigo-600 hover:underline">Lupa Password?</a>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4 hidden"></p>
                <p id="login-success" class="text-green-500 text-sm text-center mb-4 hidden"></p>
                <button type="submit" id="login-button" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 transition flex items-center justify-center">Login / Daftar</button>
            </form>
            <div class="my-4 flex items-center"><hr class="w-full border-gray-300"><span class="px-2 text-gray-500 text-sm">atau</span><hr class="w-full border-gray-300"></div>
            <button id="login-google" class="w-full bg-white border border-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-100 transition flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.53-4.18 7.12-10.12 7.12-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.82l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                Masuk dengan Google
            </button>
            <p class="text-center text-xs text-gray-400 mt-6">Pengembang: Agung Kurniawan, S.Pd.</p>
        </div>
    </div>

    <!-- ===== LAYAR APLIKASI UTAMA ===== -->
    <div id="app-screen" class="hidden"></div>

    <!-- ===== MODAL & LOADING ===== -->
    <div id="loading-screen" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 hidden"><div class="spinner"></div></div>
    
    <div id="notification-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <p id="notification-message" class="mb-4"></p>
            <button onclick="closeModal('notification-modal')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">OK</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4" id="confirm-title">Konfirmasi</h3>
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg">Batal</button>
                <button id="confirm-ok-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <div id="qr-code-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center">
            <h3 class="text-lg font-bold mb-4" id="qr-modal-title">QR Code Siswa</h3>
            <div id="qr-code-display" class="flex justify-center items-center mb-4"></div>
            <div class="flex justify-end space-x-3">
                 <button onclick="closeModal('qr-code-modal')" class="bg-gray-500 text-white px-4 py-2 rounded-lg">Tutup</button>
            </div>
        </div>
    </div>


    <script>
        // PERBAIKAN: Menambahkan event listener DOMContentLoaded
        // Ini memastikan semua skrip (termasuk Firebase) dimuat sebelum kode aplikasi dijalankan.
        document.addEventListener('DOMContentLoaded', () => {
            // =================================================================================
            // INISIALISASI GLOBAL
            // =================================================================================
            const auth = firebase.auth();
            const db = firebase.firestore();
            const googleProvider = new firebase.auth.GoogleAuthProvider();

            let currentUser = null;
            let dbRefs; 
            let localSiswaList = [];
            let localSettings = {};
            let html5QrCode;
            let confirmCallback = null;

            // =================================================================================
            // MANAJEMEN UI (TAMPILAN)
            // =================================================================================
            const loginScreen = document.getElementById('login-screen');
            const appScreen = document.getElementById('app-screen');
            const loadingScreen = document.getElementById('loading-screen');
            const loginForm = document.getElementById('loginForm');
            const loginGoogleBtn = document.getElementById('login-google');
            const loginError = document.getElementById('login-error');
            const loginSuccess = document.getElementById('login-success');
            const loginButton = document.getElementById('login-button');
            const forgotPasswordLink = document.getElementById('forgot-password-link');

            const showLoading = () => loadingScreen.classList.remove('hidden');
            const hideLoading = () => loadingScreen.classList.add('hidden');

            window.showModal = (modalId) => { document.getElementById(modalId).classList.remove('hidden'); }
            window.closeModal = (modalId) => { document.getElementById(modalId).classList.add('hidden'); }

            function showNotification(message) {
                document.getElementById('notification-message').textContent = message;
                showModal('notification-modal');
            }

            function showConfirm(title, message, callback) {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                confirmCallback = callback;
                showModal('confirm-modal');
            }

            // =================================================================================
            // FUNGSI AUTENTIKASI
            // =================================================================================
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                loginButton.disabled = true;
                loginButton.textContent = 'Memproses...';
                loginError.classList.add('hidden');
                loginSuccess.classList.add('hidden');

                auth.signInWithEmailAndPassword(email, password)
                    .catch((error) => {
                        if (error.code === 'auth/user-not-found') {
                            auth.createUserWithEmailAndPassword(email, password)
                                .catch((createError) => {
                                    loginError.textContent = createError.message;
                                    loginError.classList.remove('hidden');
                                });
                        } else {
                            loginError.textContent = error.message;
                            loginError.classList.remove('hidden');
                        }
                    })
                    .finally(() => {
                        loginButton.disabled = false;
                        loginButton.textContent = 'Login / Daftar';
                    });
            });

            loginGoogleBtn.addEventListener('click', () => {
                loginError.classList.add('hidden');
                auth.signInWithPopup(googleProvider).catch((error) => {
                    loginError.textContent = `Error Google Sign-In: ${error.message}`;
                    loginError.classList.remove('hidden');
                });
            });

            forgotPasswordLink.addEventListener('click', (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value;
                if (!email) {
                    loginError.textContent = 'Silakan masukkan email Anda untuk reset password.';
                    loginError.classList.remove('hidden');
                    return;
                }
                
                showLoading();
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        hideLoading();
                        loginError.classList.add('hidden');
                        loginSuccess.textContent = `Email reset password telah dikirim ke ${email}. Silakan cek inbox Anda.`;
                        loginSuccess.classList.remove('hidden');
                    })
                    .catch((error) => {
                        hideLoading();
                        loginSuccess.classList.add('hidden');
                        loginError.textContent = error.message;
                        loginError.classList.remove('hidden');
                    });
            });

            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    dbRefs = {
                        siswa: db.collection('users').doc(currentUser.uid).collection('siswa'),
                        absensi: db.collection('users').doc(currentUser.uid).collection('absensi'),
                        pengaturan: db.collection('users').doc(currentUser.uid).collection('pengaturan').doc('dataSekolah')
                    };
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    initializeApp();
                } else {
                    currentUser = null;
                    loginScreen.classList.remove('hidden');
                    appScreen.classList.add('hidden');
                    appScreen.innerHTML = '';
                }
            });

            window.handleLogout = () => {
                if (html5QrCode && html5QrCode.isScanning) {
                    stopScanner();
                }
                auth.signOut();
            }
            
            // =================================================================================
            // INISIALISASI APLIKASI UTAMA
            // =================================================================================
            async function initializeApp() {
                showLoading();
                renderAppLayout(); // Render kerangka HTML aplikasi
                document.getElementById('user-email').textContent = currentUser.email;

                await Promise.all([
                    loadAndRenderSiswa(),
                    loadAndRenderPengaturan(),
                ]);
                
                setupEventListeners(); // Pasang semua event listener setelah HTML dirender
                showPage('dashboard');
                hideLoading();
            }

            // =================================================================================
            // FUNGSI DATABASE (FIRESTORE)
            // =================================================================================
            async function loadAndRenderSiswa() {
                if (!dbRefs) return;
                const snapshot = await dbRefs.siswa.orderBy('nama').get();
                localSiswaList = [];
                snapshot.forEach(doc => {
                    localSiswaList.push({ id: doc.id, ...doc.data() });
                });
                renderSiswaTable(localSiswaList); 
            }

            async function addSiswaBatch(siswaArray) {
                if (!dbRefs || siswaArray.length === 0) return;
                showLoading();
                const batch = db.batch();
                siswaArray.forEach(siswa => {
                    const docRef = dbRefs.siswa.doc(); // Buat ref dokumen baru
                    batch.set(docRef, siswa);
                });
                await batch.commit();
                await loadAndRenderSiswa();
                hideLoading();
                showNotification(`${siswaArray.length} siswa berhasil diimpor.`);
            }

            async function deleteSiswa(siswaId) {
                if (!dbRefs) return;
                showLoading();
                await dbRefs.siswa.doc(siswaId).delete();
                await loadAndRenderSiswa();
                hideLoading();
            }

            async function loadAndRenderPengaturan() {
                if (!dbRefs) return;
                const doc = await dbRefs.pengaturan.get();
                if (doc.exists) {
                    localSettings = doc.data();
                    document.getElementById('namaSekolah').value = localSettings.namaSekolah || '';
                    document.getElementById('alamatSekolah').value = localSettings.alamatSekolah || '';
                    document.getElementById('kepalaSekolah').value = localSettings.kepalaSekolah || '';
                    document.getElementById('nipKepsek').value = localSettings.nipKepsek || '';
                }
            }
            
            async function savePengaturan() {
                if (!dbRefs) return;
                const settingsData = {
                    namaSekolah: document.getElementById('namaSekolah').value,
                    alamatSekolah: document.getElementById('alamatSekolah').value,
                    kepalaSekolah: document.getElementById('kepalaSekolah').value,
                    nipKepsek: document.getElementById('nipKepsek').value,
                };
                showLoading();
                await dbRefs.pengaturan.set(settingsData, { merge: true }); 
                localSettings = settingsData; // Update cache lokal
                hideLoading();
                showNotification('Pengaturan berhasil disimpan!');
            }

            async function saveAbsensi(siswaId, status) {
                if (!dbRefs) return;
                const siswa = localSiswaList.find(s => s.id === siswaId);
                if (!siswa) return;

                const dateId = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const time = new Date().toLocaleTimeString('id-ID'); // HH:MM:SS
                const absensiRef = dbRefs.absensi.doc(dateId);

                const absensiData = {
                    [`${siswaId}.nama`]: siswa.nama,
                    [`${siswaId}.nis`]: siswa.nis,
                    [`${siswaId}.kelas`]: siswa.kelas,
                    [`${siswaId}.status`]: status,
                    [`${siswaId}.waktu`]: time
                };
                
                await absensiRef.set(absensiData, { merge: true });
                
                const synth = new Tone.Synth().toDestination();
                synth.triggerAttackRelease("C5", "8n");
                const scanResultDiv = document.getElementById('scan-result');
                scanResultDiv.innerHTML = `<div class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4" role="alert">
                    <p class="font-bold">Berhasil</p>
                    <p>${siswa.nama} (${siswa.kelas}) berhasil diabsen pada ${time}.</p>
                </div>`;
                setTimeout(() => scanResultDiv.innerHTML = '', 5000);
            }

            // =================================================================================
            // FUNGSI RENDER TAMPILAN APLIKASI
            // =================================================================================
            function renderAppLayout() {
                appScreen.innerHTML = `
                    <div class="container mx-auto p-4 md:p-6 max-w-7xl">
                        <header class="bg-white shadow-md rounded-xl p-4 mb-6 flex justify-between items-center no-print">
                            <div>
                               <h1 class="text-xl md:text-2xl font-bold text-gray-800">Absensi Siswa QR</h1>
                               <p id="user-email" class="text-xs text-gray-500"></p>
                            </div>
                            <button onclick="handleLogout()" class="bg-red-500 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-600 transition">Logout</button>
                        </header>
                        <nav class="grid grid-cols-2 sm:flex sm:flex-wrap justify-center items-center gap-2 mb-6 no-print">
                            <button onclick="showPage('dashboard')" class="nav-link bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition">Dashboard</button>
                            <button onclick="showPage('siswa')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Siswa</button>
                            <button onclick="showPage('scanner')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Pindai Absen</button>
                            <button onclick="showPage('laporan')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Laporan</button>
                            <button onclick="showPage('pengaturan')" class="nav-link bg-white text-gray-700 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-200 transition">Pengaturan</button>
                        </nav>
                        <main>
                           ${getDashboardPageHTML()}
                           ${getSiswaPageHTML()}
                           ${getScannerPageHTML()}
                           ${getLaporanPageHTML()}
                           ${getPengaturanPageHTML()}
                        </main>
                        <div id="print-area"></div>
                    </div>
                `;
            }

            function getDashboardPageHTML() {
                return `<div id="dashboard" class="page active bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Selamat Datang!</h2>
                    <p class="text-gray-600">Ini adalah aplikasi absensi siswa berbasis QR Code yang terhubung dengan Firebase. Data Anda disimpan secara online dan aman.</p>
                    <div class="mt-6 grid md:grid-cols-3 gap-4">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h3 class="font-bold text-blue-800">Kelola Siswa</h3>
                            <p class="text-sm text-blue-700">Tambah, hapus, dan impor data siswa dengan mudah.</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h3 class="font-bold text-green-800">Pindai Absen</h3>
                            <p class="text-sm text-green-700">Gunakan kamera untuk melakukan absensi secara cepat dan akurat.</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="font-bold text-purple-800">Cetak Laporan</h3>
                            <p class="text-sm text-purple-700">Ekspor data absensi harian ke dalam format PDF atau Excel.</p>
                        </div>
                    </div>
                </div>`;
            }

            function getSiswaPageHTML() {
                return `<div id="siswa" class="page bg-white p-6 rounded-xl shadow-md">
                    <div class="flex flex-wrap justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Kelola Data Siswa</h2>
                        <button id="cetak-semua-qr-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600">Cetak Semua Kartu QR</button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Tambah Siswa Baru</h3>
                            <form id="form-tambah-siswa" class="space-y-3">
                                <input type="text" id="namaSiswa" placeholder="Nama Lengkap" class="w-full p-2 border rounded" required>
                                <input type="text" id="nisSiswa" placeholder="NIS / NISN" class="w-full p-2 border rounded" required>
                                <input type="text" id="kelasSiswa" placeholder="Kelas" class="w-full p-2 border rounded" required>
                                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Tambah Siswa</button>
                            </form>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Impor dari Excel</h3>
                            <p class="text-sm text-gray-500 mb-2">Unggah file Excel (.xlsx) dengan kolom: NAMA, NIS, KELAS.</p>
                            <input type="file" id="excel-file-input" accept=".xlsx" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nama</th><th scope="col" class="px-6 py-3">NIS/NISN</th><th scope="col" class="px-6 py-3">Kelas</th><th scope="col" class="px-6 py-3">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswa-table-body"></tbody>
                        </table>
                    </div>
                </div>`;
            }
            
            function getScannerPageHTML() { 
                return `<div id="scanner" class="page bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Pindai Kode QR Absensi</h2>
                    <div class="max-w-md mx-auto">
                        <div id="qr-reader" class="w-full rounded-lg overflow-hidden"></div>
                        <div id="scan-result" class="mt-4"></div>
                    </div>
                </div>`;
            }

            function getLaporanPageHTML() { 
                return `<div id="laporan" class="page bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Laporan Absensi</h2>
                    <div class="flex items-center space-x-4 mb-4">
                        <input type="date" id="tanggal-laporan" class="p-2 border rounded">
                        <button id="tampilkan-laporan-btn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tampilkan</button>
                    </div>
                    <div id="laporan-controls" class="hidden flex items-center space-x-4 mb-4">
                        <button id="export-pdf-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Ekspor PDF</button>
                        <button id="export-excel-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Ekspor Excel</button>
                    </div>
                    <div id="laporan-content" class="overflow-x-auto"></div>
                </div>`;
            }

            function getPengaturanPageHTML() {
                return `<div id="pengaturan" class="page bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold mb-4">Pengaturan Aplikasi</h2>
                    <form id="form-pengaturan" class="space-y-4 max-w-lg">
                        <div>
                            <label for="namaSekolah" class="block font-medium">Nama Sekolah</label>
                            <input type="text" id="namaSekolah" class="w-full p-2 border rounded mt-1">
                        </div>
                        <div>
                            <label for="alamatSekolah" class="block font-medium">Alamat Sekolah</label>
                            <input type="text" id="alamatSekolah" class="w-full p-2 border rounded mt-1">
                        </div>
                        <div>
                            <label for="kepalaSekolah" class="block font-medium">Nama Kepala Sekolah</label>
                            <input type="text" id="kepalaSekolah" class="w-full p-2 border rounded mt-1">
                        </div>
                        <div>
                            <label for="nipKepsek" class="block font-medium">NIP Kepala Sekolah</label>
                            <input type="text" id="nipKepsek" class="w-full p-2 border rounded mt-1">
                        </div>
                        <button type="submit" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">Simpan Pengaturan</button>
                    </form>
                </div>`;
            }

            function renderSiswaTable(siswaList) {
                const tableBody = document.getElementById('siswa-table-body');
                if (!tableBody) return;
                tableBody.innerHTML = '';
                if (siswaList.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4">Belum ada data siswa.</td></tr>`;
                    return;
                }
                siswaList.forEach(siswa => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b';
                    row.innerHTML = `
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${siswa.nama}</td>
                        <td class="px-6 py-4">${siswa.nis}</td>
                        <td class="px-6 py-4">${siswa.kelas}</td>
                        <td class="px-6 py-4 space-x-2">
                            <button class="font-medium text-blue-600 hover:underline" onclick="generateAndShowQR('${siswa.id}')">QR</button>
                            <button class="font-medium text-red-600 hover:underline" onclick="confirmDeleteSiswa('${siswa.id}', '${siswa.nama}')">Hapus</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // =================================================================================
            // EVENT LISTENERS & LOGIKA APLIKASI
            // =================================================================================
            function setupEventListeners() {
                document.getElementById('form-tambah-siswa').addEventListener('submit', (e) => {
                    e.preventDefault();
                    const siswaData = {
                        nama: document.getElementById('namaSiswa').value,
                        nis: document.getElementById('nisSiswa').value,
                        kelas: document.getElementById('kelasSiswa').value,
                    };
                    addSiswaBatch([siswaData]);
                    e.target.reset();
                });

                document.getElementById('form-pengaturan').addEventListener('submit', (e) => {
                    e.preventDefault();
                    savePengaturan();
                });

                document.getElementById('excel-file-input').addEventListener('change', handleImporExcel);
                document.getElementById('cetak-semua-qr-btn').addEventListener('click', cetakSemuaQR);
                document.getElementById('tampilkan-laporan-btn').addEventListener('click', tampilkanLaporan);

                document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback();
                    }
                    closeModal('confirm-modal');
                    confirmCallback = null;
                });

                document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                    closeModal('confirm-modal');
                    confirmCallback = null;
                });
            }
            
            window.confirmDeleteSiswa = (id, nama) => {
                showConfirm('Hapus Siswa', `Apakah Anda yakin ingin menghapus siswa bernama "${nama}"?`, () => {
                    deleteSiswa(id);
                });
            }

            function handleImporExcel(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    const siswaBaru = json.map(row => ({
                        nama: row.NAMA || '',
                        nis: String(row.NIS || ''),
                        kelas: row.KELAS || ''
                    })).filter(s => s.nama && s.nis);

                    if (siswaBaru.length > 0) {
                        addSiswaBatch(siswaBaru);
                    } else {
                        showNotification('Format Excel tidak sesuai atau tidak ada data untuk diimpor.');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
            
            window.generateAndShowQR = (id) => {
                const siswa = localSiswaList.find(s => s.id === id);
                if(siswa) {
                    const qrDisplay = document.getElementById('qr-code-display');
                    qrDisplay.innerHTML = '';
                    new QRCode(qrDisplay, {
                        text: siswa.id,
                        width: 200,
                        height: 200,
                    });
                    document.getElementById('qr-modal-title').textContent = `QR Code - ${siswa.nama}`;
                    showModal('qr-code-modal');
                }
            }

            function cetakSemuaQR() {
                const printArea = document.getElementById('print-area');
                printArea.innerHTML = '';
                
                const header = `
                    <div class="text-center mb-4">
                        <h2 class="text-xl font-bold">${localSettings.namaSekolah || 'Nama Sekolah'}</h2>
                        <p class="text-sm">${localSettings.alamatSekolah || 'Alamat Sekolah'}</p>
                        <hr class="my-2">
                        <h3 class="text-lg font-semibold">KARTU ABSENSI SISWA</h3>
                    </div>
                `;
                
                const cardsHTML = localSiswaList.map(siswa => {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'qr-card';
                    
                    const qrContainer = document.createElement('div');
                    new QRCode(qrContainer, { text: siswa.id, width: 150, height: 150 });

                    cardContainer.innerHTML = `
                        <div class="font-bold">${siswa.nama}</div>
                        <div>${qrContainer.innerHTML}</div>
                        <div>
                            <p class="text-sm">${siswa.nis}</p>
                            <p class="text-sm font-semibold">${siswa.kelas}</p>
                        </div>
                    `;
                    return `<div class="inline-block m-2">${cardContainer.outerHTML}</div>`;
                }).join('');

                printArea.innerHTML = header + '<div class="flex flex-wrap justify-center">' + cardsHTML + '</div>';
                window.print();
                printArea.innerHTML = '';
            }

            function startScanner() {
                html5QrCode = new Html5Qrcode("qr-reader");
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure);
            }

            function stopScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Gagal menghentikan scanner.", err));
                }
            }

            function onScanSuccess(decodedText, decodedResult) {
                const siswaExists = localSiswaList.some(s => s.id === decodedText);
                if (siswaExists) {
                    saveAbsensi(decodedText, 'Hadir');
                } else {
                    const synth = new Tone.Synth().toDestination();
                    synth.triggerAttackRelease("C4", "8n");
                    const scanResultDiv = document.getElementById('scan-result');
                    scanResultDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
                        <p class="font-bold">Gagal</p>
                        <p>Siswa dengan ID ini tidak ditemukan.</p>
                    </div>`;
                    setTimeout(() => scanResultDiv.innerHTML = '', 5000);
                }
            }

            function onScanFailure(error) {
                // Abaikan error
            }

            async function tampilkanLaporan() {
                const tanggal = document.getElementById('tanggal-laporan').value;
                if (!tanggal) {
                    showNotification("Silakan pilih tanggal terlebih dahulu.");
                    return;
                }

                showLoading();
                const absensiRef = dbRefs.absensi.doc(tanggal);
                const doc = await absensiRef.get();
                hideLoading();

                const laporanContent = document.getElementById('laporan-content');
                if (!doc.exists) {
                    laporanContent.innerHTML = `<p class="text-center text-gray-500">Tidak ada data absensi untuk tanggal ${tanggal}.</p>`;
                    document.getElementById('laporan-controls').classList.add('hidden');
                    return;
                }

                const dataAbsensi = doc.data();
                const dataArray = Object.values(dataAbsensi);

                laporanContent.innerHTML = `
                    <h3 class="text-xl font-bold text-center">${localSettings.namaSekolah || ''}</h3>
                    <p class="text-center">${localSettings.alamatSekolah || ''}</p>
                    <hr class="my-2">
                    <h4 class="text-lg font-semibold mb-2">Laporan Absensi Tanggal: ${new Date(tanggal + 'T00:00:00').toLocaleDateString('id-ID', { dateStyle: 'full' })}</h4>
                    <table class="w-full text-sm text-left text-gray-500 mt-4">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th class="px-6 py-3">Nama</th><th class="px-6 py-3">NIS</th><th class="px-6 py-3">Kelas</th><th class="px-6 py-3">Waktu</th><th class="px-6 py-3">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dataArray.map(d => `
                                <tr class="bg-white border-b">
                                    <td class="px-6 py-4">${d.nama}</td><td class="px-6 py-4">${d.nis}</td><td class="px-6 py-4">${d.kelas}</td><td class="px-6 py-4">${d.waktu}</td><td class="px-6 py-4">${d.status}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
                const controls = document.getElementById('laporan-controls');
                controls.classList.remove('hidden');
                
                const newPdfBtn = controls.querySelector('#export-pdf-btn').cloneNode(true);
                const newExcelBtn = controls.querySelector('#export-excel-btn').cloneNode(true);
                controls.querySelector('#export-pdf-btn').replaceWith(newPdfBtn);
                controls.querySelector('#export-excel-btn').replaceWith(newExcelBtn);
                
                newPdfBtn.addEventListener('click', () => exportLaporanPDF(dataArray, tanggal));
                newExcelBtn.addEventListener('click', () => exportLaporanExcel(dataArray, tanggal));
            }

            function exportLaporanPDF(data, tanggal) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(16);
                doc.text(localSettings.namaSekolah || 'Laporan Absensi', 105, 15, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Tanggal: ${new Date(tanggal + 'T00:00:00').toLocaleDateString('id-ID', { dateStyle: 'full' })}`, 105, 22, { align: 'center' });

                const tableData = data.map(d => [d.nama, d.nis, d.kelas, d.waktu, d.status]);
                
                doc.autoTable({
                    startY: 30,
                    head: [['Nama', 'NIS', 'Kelas', 'Waktu', 'Status']],
                    body: tableData,
                });

                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(10);
                    const text = `Kepala Sekolah, ${localSettings.kepalaSekolah || '.........................'}`;
                    const textWidth = doc.getStringUnitWidth(text) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    doc.text(text, doc.internal.pageSize.width - 20 - textWidth, doc.internal.pageSize.height - 30);
                    const text2 = `NIP. ${localSettings.nipKepsek || '.........................'}`;
                    const textWidth2 = doc.getStringUnitWidth(text2) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    doc.text(text2, doc.internal.pageSize.width - 20 - textWidth2, doc.internal.pageSize.height - 15);
                }

                doc.save(`laporan_absensi_${tanggal}.pdf`);
            }

            function exportLaporanExcel(data, tanggal) {
                const worksheet = XLSX.utils.json_to_sheet(data.map(d => ({
                    Nama: d.nama,
                    NIS: d.nis,
                    Kelas: d.kelas,
                    Waktu: d.waktu,
                    Status: d.status
                })));
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Absensi");
                XLSX.writeFile(workbook, `laporan_absensi_${tanggal}.xlsx`);
            }

            window.showPage = (pageId) => {
                if (html5QrCode && html5QrCode.isScanning) {
                    stopScanner();
                }

                document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('bg-indigo-600', 'text-white');
                    link.classList.add('bg-white', 'text-gray-700');
                });
                
                const activePage = document.getElementById(pageId);
                const activeLink = document.querySelector(`.nav-link[onclick="showPage('${pageId}')"]`);
                
                if(activePage) activePage.classList.add('active');
                if(activeLink) {
                    activeLink.classList.add('bg-indigo-600', 'text-white');
                    activeLink.classList.remove('bg-white', 'text-gray-700');
                }

                if (pageId === 'scanner') {
                    startScanner();
                }
            }
        }); // Akhir dari DOMContentLoaded
    </script>
</body>
</html>